<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dispatch Report</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }

  h2 {
    margin-bottom: 15px;
  }

  .container {
    display: flex;
    gap: 20px;
  }

  .left {
    width: 25%;
  }

  .right {
    width: 75%;
    overflow-x: auto;
  }

  select {
    width: 100%;
    padding: 8px;
    font-size: 14px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
    min-width: max-content;
  }

  th {
    background-color: #f4f4f4;
    font-weight: bold;
    white-space: nowrap;
    padding: 10px 14px;
    text-align: center;
  }

  td {
    white-space: nowrap;
    padding: 8px 12px;
    text-align: center;
  }

  tr:nth-child(even) {
    background-color: #fafafa;
  }

  thead th {
    position: sticky;
    top: 0;
    z-index: 2;
  }
</style>
</head>

<body>

<h2>Dispatch Report</h2>

<div class="container">

  <!-- LEFT -->
  <div class="left">
    <label><strong>Select Dispatch Date</strong></label><br><br>
    <select id="dateDropdown">
      <option value="">-- Select Date --</option>
    </select>

    <!-- ✅ ADDED: TAG DROPDOWN -->
    <br><br>
    <label><strong>Select Cattle Tag</strong></label><br><br>
    <select id="tagDropdown">
      <option value="">-- All Tags --</option>
    </select>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="tableBody">
        <tr>
          <td colspan="20">Select a dispatch date or tag</td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<script>
  const CSV_URL =
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDfBMq6WxkWO6YvFADvJf8wi7U240TwOLgKujdYZ0TUeR0GjKICxo9Ce6sjEcSVaQyGyLEuFqaIRLV/pub?output=csv";
  let sheetData = [];

  fetch(CSV_URL)
    .then(res => res.text())
    .then(csv => {
      const rows = parseCSV(csv);
      const headers = rows[0];
      sheetData = rows.slice(1);
      buildTableHead(headers);
      loadDropdowns();
    });

  function parseCSV(text) {
    const rows = [];
    let row = [];
    let value = "";
    let insideQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      const next = text[i + 1];

      if (char === '"' && insideQuotes && next === '"') {
        value += '"';
        i++;
      } else if (char === '"') {
        insideQuotes = !insideQuotes;
      } else if (char === "," && !insideQuotes) {
        row.push(value);
        value = "";
      } else if (char === "\n" && !insideQuotes) {
        row.push(value);
        rows.push(row);
        row = [];
        value = "";
      } else {
        value += char;
      }
    }

    if (value || row.length) {
      row.push(value);
      rows.push(row);
    }

    return rows.map(r => r.map(c => c.trim()));
  }

  /* ✅ UPDATED: LOAD BOTH DROPDOWNS */
  function loadDropdowns() {
    const dateDropdown = document.getElementById("dateDropdown");
    const tagDropdown = document.getElementById("tagDropdown");

    dateDropdown.innerHTML = `<option value="">-- Select Date --</option>`;
    tagDropdown.innerHTML = `<option value="">-- All Tags --</option>`;

    const dates = [...new Set(sheetData.map(r => r[1]))].filter(Boolean);
    const tags = [...new Set(sheetData.map(r => r[0]))].filter(Boolean);

    dates.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      dateDropdown.appendChild(opt);
    });

    tags.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      tagDropdown.appendChild(opt);
    });

    dateDropdown.addEventListener("change", filterTable);
    tagDropdown.addEventListener("change", filterTable);
  }

  /* ✅ UPDATED FILTER LOGIC */
  function filterTable() {
    const selectedDate = document.getElementById("dateDropdown").value;
    const selectedTag = document.getElementById("tagDropdown").value;

    const tbody = document.getElementById("tableBody");
    let html = "";

    sheetData.forEach(row => {
      const matchDate = !selectedDate || row[1] === selectedDate;
      const matchTag = !selectedTag || row[0] === selectedTag;

      if (matchDate && matchTag) {
        html += "<tr>";
        row.forEach(cell => {
          html += `<td>${cell}</td>`;
        });
        html += "</tr>";
      }
    });

    tbody.innerHTML =
      html || "<tr><td colspan='20'>No data found</td></tr>";
  }

  function buildTableHead(headers) {
    const thead = document.getElementById("tableHead");
    let html = "<tr>";
    headers.forEach(h => html += `<th>${h}</th>`);
    html += "</tr>";
    thead.innerHTML = html;
  }
</script>

</body>
</html>


